import requests
import sqlite3
from config_data.api import url, headers
from database.models import *
from loader import bot
from telebot.types import Message


@bot.message_handler(commands=['low'])
def get_low_film(message: Message):
    """ –ö–æ–º–∞–Ω–¥–∞ /low –ø–æ–∫–∞–∂–µ—Ç –≤–∞–º –∫–∞–∫–æ–π —Ñ–∏–ª—å–º –∑–∞–Ω–∏–º–∞–µ—Ç —Ç–æ–ø –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ —Å –Ω–∏–∑–∫–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º IMDb """
    response = requests.get(url, headers=headers)
    if response.status_code != 200:
        bot.send_message(message.from_user.id, f'üòî–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∏–ª—å–º–æ–≤.')

    films = response.json()
    """ –°–∞–º —Ñ–∏–ª—å–º –∏ –µ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã """
    low_rate_film = min(films, key=lambda x: x['rating'])
    name_film = low_rate_film['title']
    user_id = message.from_user.id
    low_film_year = low_rate_film['year']
    low_film_rating = low_rate_film['rating']
    url_image = low_rate_film['image']
    film_thumbnail = low_rate_film['thumbnail']
    film_genre = low_rate_film['genre']
    film_description = low_rate_film['description']

    user = User.get(User.telegram_id == message.from_user.id)
    bot.reply_to(message, f'–£–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ - –∏—â—É üëÄ')
    FilmInfo.create(
        film_name=name_film,
        user=user.id,
        user_id_for_table=user_id,
        film_rating=low_film_rating,
        film_year=low_film_year
    ).save()
    with sqlite3.connect('database.db') as conn:
        cursor = conn.cursor()
        cursor.execute("""SELECT * FROM films""")
        print(cursor.fetchall())

    bot.send_message(message.from_user.id, f'üïµÔ∏è‚Äç‚ôÇÔ∏è –ù–∞—à–µ–ª –¥–ª—è –≤–∞—Å —Ñ–∏–ª—å–º/–º—É–ª—å—Ç—Ñ–∏–ª—å–º —Å –Ω–∏–∑–∫–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º IMDb Top 100.')
    bot.send_message(message.from_user.id, f'‚úçÔ∏è–ñ–∞–Ω—Ä —Ñ–∏–ª—å–º–∞/–º—É–ª—å—Ç—Ñ–∏–ª—å–º–∞: {', '.join(film_genre)}')
    bot.send_message(message.from_user.id, f'üí¨–ö—Ä–∞—Ç–∫–∏–π —Å—é–∂–µ—Ç –∏ –º–∏–Ω–∏–∞—Ç—é—Ä–∞:\n {film_description}')
    bot.send_message(message.from_user.id, film_thumbnail)
    bot.send_photo(message.from_user.id, requests.get(url_image).content)

    bot.delete_state(message.from_user.id, message.chat.id)


